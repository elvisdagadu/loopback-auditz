{"version":3,"sources":["auditz.js"],"names":["assert","require","debug","warn","options","rest","silenceWarnings","Object","compare","obj1","obj2","p","hasOwnProperty","toString","Model","bootOptions","modelName","app","createdAt","updatedAt","deletedAt","createdBy","updatedBy","deletedBy","softDelete","unknownUser","scrub","required","validateUpsert","revisions","name","idType","dataSource","autoUpdate","remoteContextData","revisionsModelName","properties","definition","idName","scrubbed","propertiesToScrub","Array","isArray","filter","prop","reduce","obj","settings","pluralModelName","defineProperty","type","Date","defaultFn","String","observe","ctx","next","currentUser","accessToken","userId","getApp","err","a","ipForwarded","ip","groups","saveGroups","count","delete","forEach","group","createOrUpdateRevision","length","isNewInstance","data","action","table_name","row_id","instance","id","old","new","user","ip_forwarded","property","models","create","oldInstance","oldInstances","entries","map","inst","updatedIds","newInst","query","where","inq","find","error","newInstances","cloneKey","key","from","to","parts","split","toObject","fromObject","index","cb","rec","recNew","JSON","parse","recOld","console","log","getOldInstance","remoteCtx","req","args","findById","deleted","result","skipUpdatedAt","keyAt","keyBy","destroyAll","softDestroyAll","opt","callback","undefined","newOpt","updateAll","then","catch","reject","remove","deleteAll","destroyById","softDestroyById","removeById","deleteById","prototype","destroy","softDestroy","updateAttributes","queryNonDeleted","_findOrCreate","findOrCreate","findOrCreateDeleted","and","call","_find","findDeleted","_count","countDeleted","whereNotDeleted","_update","update","updateDeleted","_setupRevisionsModel","opts","dsName","rowIdType","_createModel","revisionsDef","s","plural","revisionsModel","dataSources","createModel","model","autoupdate"],"mappings":"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","file":"auditz.js","sourcesContent":["import _debug from './debug';\nconst assert = require('assert');\n\nconst debug = _debug();\nconst warn = (options, ...rest) => {\n  if (!options.silenceWarnings) {\n    console.warn(...rest);\n  }\n};\n\nObject.compare = function(obj1, obj2) {\n\t//Loop through properties in object 1\n\t              for (var p in obj1) {\n\t\t//Check property exists on both objects\n\t\t              if (obj1.hasOwnProperty(p) !== obj2.hasOwnProperty(p)) return false;\n  if (obj1[p] === null || obj2[p] === null) {\n    return obj1[p] === obj2[p];\n  }\n\n\t\t              switch (typeof (obj1[p])) {\n\t\t\t//Deep compare objects\n\t\t\tcase 'object':\n  if (typeof (obj2[p]) !== 'object') return false;\n\t\t\t\t              if (!Object.compare(obj1[p], obj2[p])) return false;\n\t\t\t\t              break;\n\t\t\t//Compare function code\n\t\t\tcase 'function':\n\t\t\t\t              if (typeof (obj2[p]) === 'undefined' || (p !== 'compare' && obj1[p].toString() !== obj2[p].toString())) return false;\n\t\t\t\t              break;\n\t\t\t//Compare values\n\t\t\tdefault:\n\t\t\t\t              if (obj1[p] !== obj2[p]) return false;\n\t\t}\n\t}\n\n\t//Check object 2 for any extra properties\n\t              for (var p in obj2) {\n\t\t              if (typeof (obj1[p]) === 'undefined') return false;\n\t}\n\t              return true;\n};\n\nexport default (Model, bootOptions = {}) => {\n  debug('Auditz mixin for Model %s', Model.modelName);\n  let app;\n\n  const options = Object.assign({\n    createdAt: 'createdAt',\n    updatedAt: 'updatedAt',\n    deletedAt: 'deletedAt',\n    createdBy: 'createdBy',\n    updatedBy: 'updatedBy',\n    deletedBy: 'deletedBy',\n    softDelete: true,\n    unknownUser: '0',\n    scrub: false,\n    required: true,\n    validateUpsert: false, // default to turning validation off\n    silenceWarnings: false,\n    revisions: {\n      name: 'revisions',\n      idType: 'Number',\n      dataSource: 'db',\n      autoUpdate: true,\n      remoteContextData: [],\n    },\n  }, bootOptions);\n\n  options.revisionsModelName = (typeof options.revisions === 'object' && options.revisions.name) ?\n    options.revisions.name : null;\n  debug('options', options);\n\n  const properties = Model.definition.properties;\n  const idName = Model.dataSource.idName(Model.modelName);\n\n  let scrubbed = {};\n  if (options.softDelete) {\n    if (options.scrub !== false) {\n      let propertiesToScrub = options.scrub;\n      if (!Array.isArray(propertiesToScrub)) {\n        propertiesToScrub = Object.keys(properties)\n          .filter(prop => !properties[prop][idName] && prop !== options.deletedAt && prop !== options.deletedBy);\n      }\n      scrubbed = propertiesToScrub.reduce((obj, prop) => ({ ...obj, [prop]: null }), {});\n    }\n  }\n\n  if (!options.validateUpsert && Model.settings.validateUpsert) {\n    Model.settings.validateUpsert = false;\n    warn(options, `${Model.pluralModelName} settings.validateUpsert was overridden to false`);\n  }\n\n  if (Model.settings.validateUpsert && options.required) {\n    warn(options, `Upserts for ${Model.pluralModelName} will fail when\n          validation is turned on and time stamps are required`);\n  }\n\n  Model.settings.validateUpsert = options.validateUpsert;\n\n  if (options.createdAt !== false) {\n    if (typeof(properties[options.createdAt]) === 'undefined') {\n      Model.defineProperty(options.createdAt, {type: Date, required: options.required, defaultFn: 'now'});\n    }\n  }\n\n  if (options.updatedAt !== false) {\n    if (typeof(properties[options.updatedAt]) === 'undefined') {\n      Model.defineProperty(options.updatedAt, {type: Date, required: options.required});\n    }\n  }\n\n  if (options.createdBy !== false) {\n    if (typeof(properties[options.createdBy]) === 'undefined') {\n      Model.defineProperty(options.createdBy, {type: String, required: false});\n    }\n  }\n\n  if (options.updatedBy !== false) {\n    if (typeof(properties[options.updatedBy]) === 'undefined') {\n      Model.defineProperty(options.updatedBy, {type: String, required: false});\n    }\n  }\n\n  if (options.softDelete) {\n    if (typeof(properties[options.deletedAt]) === 'undefined') {\n      Model.defineProperty(options.deletedAt, { type: Date, required: false, 'default': null });\n    }\n    if (typeof(properties[options.deletedBy]) === 'undefined') {\n      Model.defineProperty(options.deletedBy, {type: String, required: false});\n    }\n  }\n\n  Model.observe('after save', (ctx, next) => {\n    if (!options.revisions) {\n      return next();\n    }\n    debug('ctx.options', ctx.options);\n\n    // determine the currently logged in user. Default to options.unknownUser\n    let currentUser = options.unknownUser;\n\n\n    if (ctx.options.accessToken) {\n      currentUser = ctx.options.accessToken.userId;\n    }\n\n    Model.getApp((err, a) => {\n      if (err) { return next(err); }\n      app = a;\n      let ipForwarded = '';\n      let ip = '127.0.0.1';\n      if (ctx.options.ip || ctx.options.ipForwarded) {\n        ipForwarded = ctx.options.ipForwarded || '';\n        ip = ctx.options.ip;\n      }\n      let groups = options.revisions.groups;\n\n      let saveGroups = function(err) {\n        if (err) {\n          next(err);\n          return;\n        }\n        if (groups && Array.isArray(groups)) {\n          let count = 0;\n          if (!(ctx.options && ctx.options.delete)) {\n            groups.forEach(function(group) {\n              createOrUpdateRevision(ctx, group, currentUser, ipForwarded, ip, function() {\n                count += 1;\n                if (count === groups.length) {\n                  next();\n                }\n              });\n            });\n            return;\n          }\n        }\n        next();\n      };\n\n      // If it's a new instance, set the createdBy to currentUser\n      if (ctx.isNewInstance) {\n        let data = {\n          action: 'create',\n          table_name: Model.modelName,\n          row_id: ctx.instance.id,\n          old: null,\n          new: ctx.instance,\n          user: currentUser,\n          ip: ip,\n          ip_forwarded: ipForwarded,\n        };\n\n        //this is to allow adding data from remoting context to the revisions model\n        if (options.revisions.remoteContextData && options.revisions.remoteContextData.length > 0) {\n          options.revisions.remoteContextData.forEach((property) => {\n             if (ctx.options[property]){\n               data[property] = ctx.options[property];\n             }\n           });\n        }\n\n        app.models[options.revisionsModelName].create(data, saveGroups);\n      } else {\n        if (ctx.options && ctx.options.delete) {\n          if (ctx.options.oldInstance) {\n            app.models[options.revisionsModelName].create({\n              action: 'delete',\n              table_name: Model.modelName,\n              row_id: ctx.options.oldInstance.id,\n              old: ctx.options.oldInstance,\n              new: null,\n              user: currentUser,\n              ip: ip,\n              ip_forwarded: ipForwarded,\n            }, saveGroups);\n          } else if (ctx.options.oldInstances) {\n            const entries = ctx.options.oldInstances.map(inst => {\n              return {\n                action: 'delete',\n                table_name: Model.modelName,\n                row_id: inst.id,\n                old: inst,\n                new: null,\n                user: currentUser,\n                ip: ip,\n                ip_forwarded: ipForwarded,\n              };\n            });\n            app.models[options.revisionsModelName].create(entries, saveGroups);\n          } else {\n            debug('Cannot register delete without old instance! Options: %j', ctx.options);\n            return saveGroups();\n          }\n        } else {\n          if (ctx.options.oldInstance && ctx.instance) {\n            const inst = ctx.instance;\n            app.models[options.revisionsModelName].create({\n              action: 'update',\n              table_name: Model.modelName,\n              row_id: inst.id,\n              old: ctx.options.oldInstance,\n              new: inst,\n              user: currentUser,\n              ip: ip,\n              ip_forwarded: ipForwarded,\n            }, saveGroups);\n          } else if (ctx.options.oldInstances) {\n            const updatedIds = ctx.options.oldInstances.map(inst => { return inst.id; });\n            let newInst = {};\n            const query = {where: {[ idName ]: {inq: updatedIds}}};\n            app.models[Model.modelName].find(query, (error, newInstances) => {\n              if (error) { return next(error); }\n              newInstances.forEach(inst => {\n                newInst[ inst[ idName ] ] = inst;\n              });\n              const entries = ctx.options.oldInstances.map(inst => {\n                return {\n                  action: 'update',\n                  table_name: Model.modelName,\n                  row_id: inst.id,\n                  old: inst,\n                  new: newInst[inst.id],\n                  user: currentUser,\n                  ip: ip,\n                  ip_forwarded: ipForwarded,\n                };\n              });\n              app.models[options.revisionsModelName].create(entries, saveGroups);\n            });\n          } else {\n            debug('Cannot register update without old and new instance. Options: %j', ctx.options);\n            debug('instance: %j', ctx.instance);\n            debug('data: %j', ctx.data);\n            return saveGroups();\n          }\n        }\n      }\n    });\n  });\n\n  function cloneKey(key, from, to) {\n    let parts = key.split('.');\n\n    let toObject = to;\n    let fromObject = from;\n\n    parts.forEach(function(key, index) {\n      if (index === parts.length - 1) {\n        toObject[key] = fromObject && fromObject[key];\n      } else {\n        if (!toObject[key]) {\n          toObject[key] = {};\n        }\n      }\n\n      fromObject = fromObject && fromObject[key];\n      toObject = toObject[key];\n    });\n  }\n\n  function createOrUpdateRevision(ctx, group, currentUser, ipForwarded, ip, cb) {\n    let data = {};\n    group.properties.forEach(function(key) {\n      cloneKey(key, ctx.instance, data);\n    });\n    debug(data);\n\n    let rec = {\n      table_name: Model.modelName,\n      row_id: ctx.instance.id,\n      new: data,\n      user: currentUser,\n      ip: ip,\n      ip_forwarded: ipForwarded,\n    };\n\n    if (ctx.isNewInstance) {\n      rec.action = 'create';\n      rec.old = null;\n      app.models[group.name].create(rec, cb);\n    } else {\n      rec.action = 'update';\n      rec.old = ctx.options.oldInstance || null;\n      if (rec.old) {\n        let old = {};\n        //make sure the object is pure\n        group.properties.forEach(function(key) {\n          cloneKey(key, rec.old, old);\n        });\n        rec.old = old;\n      }\n\n      //get away from undefined properties so compare can work\n      let recNew = JSON.parse(JSON.stringify(rec.new));\n      let recOld = rec.old && JSON.parse(JSON.stringify(rec.old));\n\n      if (rec.old && Object.compare(recNew, recOld)) {\n        console.log('equal ' + group.name);\n        return cb();\n      }\n      app.models[group.name].create(rec, cb);\n    }\n  }\n\n  function getOldInstance(ctx, cb) {\n    if (options.revisions) {\n      if (typeof ctx.isNewInstance === 'undefined' || !ctx.isNewInstance) {\n        let id = ctx.instance ? ctx.instance.id : null;\n        if (!id) {\n          id = ctx.data ? ctx.data.id : null;\n        }\n        if (!id && ctx.where) {\n          id = ctx.where.id;\n        }\n        if (!id && ctx.options.remoteCtx) {\n          id = ctx.options.remoteCtx.req && ctx.options.remoteCtx.req.args ?\n            ctx.options.remoteCtx.req.args.id : null;\n        }\n        if (id) {\n          Model.findById(id, {deleted: true}, (err, oldInstance) => {\n            if (err) { cb(err); } else { cb(null, oldInstance); }\n          });\n        } else {\n          const query = {where: ctx.where} || {};\n          Model.find(query, (err, oldInstances) => {\n            if (err) {\n              cb(err);\n            } else {\n              if (oldInstances.length > 1) {\n                return cb(null, oldInstances);\n              } else if (oldInstances.length === 0) {\n                return cb();\n              }\n              cb(null, oldInstances[0]);\n            }\n          });\n        }\n      } else {\n        cb();\n      }\n    } else {\n      cb();\n    }\n  }\n\n  Model.observe('before save', (ctx, next) => {\n    const softDelete = ctx.options.delete;\n\n    getOldInstance(ctx, (err, result) => {\n      if (err) {\n        console.error(err);\n        return next(err);\n      }\n\n      if (Array.isArray(result)) {\n        ctx.options.oldInstances = result;\n      } else {\n        ctx.options.oldInstance = result;\n      }\n      // determine the currently logged in user. Default to options.unknownUser\n      let currentUser = options.unknownUser;\n\n      if (ctx.options.accessToken) {\n        currentUser = ctx.options.accessToken.userId;\n      }\n\n      // If it's a new instance, set the createdBy to currentUser\n      if (ctx.isNewInstance) {\n        debug('Setting %s.%s to %s', ctx.Model.modelName, options.createdBy, currentUser);\n        ctx.instance[options.createdBy] = currentUser;\n        if (options.softDelete) {\n          ctx.instance[options.deletedAt] = null;\n        }\n      } else {\n        // if the createdBy and createdAt are sent along in the data to save, remove the keys\n        // as we don't want to let the user overwrite it\n        if (ctx.instance) {\n          delete ctx.instance[options.createdBy];\n          delete ctx.instance[options.createdAt];\n        } else {\n          delete ctx.data[options.createdBy];\n          delete ctx.data[options.createdAt];\n        }\n      }\n\n      if (ctx.options && ctx.options.skipUpdatedAt) { return next(); }\n      let keyAt = options.updatedAt;\n      let keyBy = options.updatedBy;\n      if (options.softDelete) {\n        // Since soft deletes replace the actual delete by an update, we set the option\n        // 'delete' in the overridden delete functions that perform updates.\n        // We now have to determine if we need to set updatedAt/updatedBy or\n        // deletedAt/deletedBy\n        if (softDelete) {\n          keyAt = options.deletedAt;\n          keyBy = options.deletedBy;\n        }\n      }\n\n      let obj;\n      if (ctx.instance) {\n        obj = ctx.instance;\n      } else {\n        obj = ctx.data;\n      }\n\n      if (keyAt !== false) {\n        obj[keyAt] = new Date();\n      }\n      if (keyBy !== false) {\n        obj[keyBy] = currentUser;\n      }\n\n      return next();\n    });\n  });\n\n  if (options.softDelete) {\n    Model.destroyAll = function softDestroyAll(where, opt, cb) {\n      let query = where || {};\n      let callback = (cb === undefined && typeof opt === 'function') ? opt : cb;\n      let newOpt = {delete: true};\n      if (typeof opt === 'object') {\n        newOpt = {...opt, ...newOpt};\n      }\n      if (typeof where === 'function') {\n        callback = where;\n        query = {};\n      }\n      return Model.updateAll(query, { ...scrubbed }, newOpt)\n        .then(result => (typeof callback === 'function') ? callback(null, result) : result)\n        .catch(error => (typeof callback === 'function') ? callback(error) : Promise.reject(error));\n    };\n\n    Model.remove = Model.destroyAll;\n    Model.deleteAll = Model.destroyAll;\n\n    Model.destroyById = function softDestroyById(id, opt, cb) {\n      const callback = (cb === undefined && typeof opt === 'function') ? opt : cb;\n      let newOpt = {delete: true};\n      if (typeof opt === 'object') {\n        newOpt = {...opt, ...newOpt};\n      }\n\n      return Model.updateAll({ [idName]: id }, { ...scrubbed}, newOpt)\n        .then(result => (typeof callback === 'function') ? callback(null, result) : result)\n        .catch(error => (typeof callback === 'function') ? callback(error) : Promise.reject(error));\n    };\n\n    Model.removeById = Model.destroyById;\n    Model.deleteById = Model.destroyById;\n\n    Model.prototype.destroy = function softDestroy(opt, cb) {\n      const callback = (cb === undefined && typeof opt === 'function') ? opt : cb;\n\n      return this.updateAttributes({ ...scrubbed }, {delete: true})\n        .then(result => (typeof cb === 'function') ? callback(null, result) : result)\n        .catch(error => (typeof cb === 'function') ? callback(error) : Promise.reject(error));\n    };\n\n    Model.prototype.remove = Model.prototype.destroy;\n    Model.prototype.delete = Model.prototype.destroy;\n\n    // Emulate default scope but with more flexibility.\n    const queryNonDeleted = {[options.deletedAt]: null};\n\n    const _findOrCreate = Model.findOrCreate;\n    Model.findOrCreate = function findOrCreateDeleted(query = {}, ...rest) {\n      if (!query.deleted) {\n        if (!query.where || Object.keys(query.where).length === 0) {\n          query.where = queryNonDeleted;\n        } else {\n          query.where = { and: [ query.where, queryNonDeleted ] };\n        }\n      }\n\n      return _findOrCreate.call(Model, query, ...rest);\n    };\n\n    const _find = Model.find;\n    Model.find = function findDeleted(query = {}, ...rest) {\n      if (!query.deleted) {\n        if (!query.where || Object.keys(query.where).length === 0) {\n          query.where = queryNonDeleted;\n        } else {\n          query.where = { and: [ query.where, queryNonDeleted ] };\n        }\n      }\n\n      return _find.call(Model, query, ...rest);\n    };\n\n    const _count = Model.count;\n    Model.count = function countDeleted(where = {}, ...rest) {\n      // Because count only receives a 'where', there's nowhere to ask for the deleted entities.\n      let whereNotDeleted;\n      if (!where || Object.keys(where).length === 0) {\n        whereNotDeleted = queryNonDeleted;\n      } else {\n        whereNotDeleted = { and: [ where, queryNonDeleted ] };\n      }\n      return _count.call(Model, whereNotDeleted, ...rest);\n    };\n\n    const _update = Model.update;\n    Model.update = Model.updateAll = function updateDeleted(where = {}, ...rest) {\n      // Because update/updateAll only receives a 'where', there's nowhere to ask for the deleted entities.\n      let whereNotDeleted;\n      if (!where || Object.keys(where).length === 0) {\n        whereNotDeleted = queryNonDeleted;\n      } else {\n        whereNotDeleted = { and: [ where, queryNonDeleted ] };\n      }\n      return _update.call(Model, whereNotDeleted, ...rest);\n    };\n  }\n\n  function _setupRevisionsModel(app, opts) {\n    const autoUpdate = (opts.revisions === true || (typeof opts.revisions === 'object' && opts.revisions.autoUpdate));\n    const dsName = (typeof opts.revisions === 'object' && opts.revisions.dataSource) ?\n      opts.revisions.dataSource : 'db';\n    const rowIdType = (typeof opts.revisions === 'object' && opts.revisions.idType) ?\n      opts.revisions.idType : 'Number';\n\n    if (options.revisionsModelName) {\n      _createModel(opts, dsName, autoUpdate, rowIdType, {name: options.revisionsModelName});\n    }\n    if (opts.revisions && typeof opts.revisions === 'object' &&\n       opts.revisions.groups && opts.revisions.groups.length) {\n      opts.revisions.groups.forEach(function(group) {\n        if (!app.models[group.name]) {\n          _createModel(opts, dsName, autoUpdate, rowIdType, group);\n        }\n      });\n    }\n  }\n\n  function _createModel(opts, dsName, autoUpdate, rowIdType, group) {\n    const revisionsDef = require('./models/revision.json');\n    let settings = {};\n    for (let s in revisionsDef) {\n      if (s !== 'name' && s !== 'properties') {\n        settings[s] = revisionsDef[s];\n      }\n    }\n\n    settings['plural'] = group.plural;\n\n    revisionsDef.properties.row_id.type = rowIdType;\n\n    const revisionsModel = app.dataSources[dsName].createModel(\n      group.name,\n      revisionsDef.properties,\n      settings\n    );\n    const revisions = require('./models/revision')(revisionsModel, opts);\n\n    app.model(revisions);\n\n\n    if (autoUpdate) {\n      // create or update the revisions table\n      app.dataSources[dsName].autoupdate([group.name], (error) => {\n        if (error) {console.error(error);}\n      });\n    }\n  }\n\n  if (options.revisions) {\n    Model.getApp((err, a) => {\n      if (err) { return console.error(err);}\n      app = a;\n      if (!app.models[options.revisionsModelName]) {\n        _setupRevisionsModel(app, options);\n      }\n    });\n  }\n};\n"],"sourceRoot":"/Volumes/Projects/Projects/loopback-auditz/src"}